<dom-module id="x-app">
  <style>
    .item {
      margin: 8px;
      padding: 8px;
      border-radius: 2px;
      background-color: #fff;
    }
    .iron-selected {
      background-color: var(--paper-light-blue-50);
    }
  </style>
  <template>

    <paper-header-panel class="fit">

      <paper-toolbar>
        <div class="title">Yeti 575</div>
        <span class="flex"></span>
        <paper-icon-button icon="file-upload" on-tap="onUploadFile"></paper-icon-button>
      </paper-toolbar>

      <div class="container fit">

        <iron-selector selectedItems="{{selectedItems}}" multi>
        <template is="dom-repeat" items="{{files}}">
          <paper-icon-item class="item">
            <iron-icon icon="settings" item-icon></iron-icon>
            <paper-item-body two-line>
              <div>{{item.displayName}}</div>
              <div secondary>{{item.count}}</div>
            </paper-item-body>
            <span class="flex"></span>
            <paper-icon-button icon="delete" on-tap="onDeleteFile"></paper-icon-button>
          </paper-icon-item>
        </template>
        </iron-selector>

      </div>

    </paper-header-panel>

    <paper-dialog id="dialog">
      <h2>Choose file to upload</h2>
      <input type="file" files="{{uploadFileList::change}}" />
      <div class="buttons">
        <paper-button dialog-dismiss>Cancel</paper-button>
        <paper-button dialog-confirm on-tap="uploadFile">Upload</paper-button>
      </div>
    </paper-dialog>

    <iron-ajax
        id="files_request"
        auto
        url="/file"
        handle-as="json"
        on-response="handleResponse">
    </iron-ajax>

  </template>
</dom-module>

<script>
  (function(Polymer) {

    Polymer({
      is: 'x-app',

      properties: {
        files: {
          type: Array
        },
        uploadFileList: {
          type: Object
        },
        selectedItems: {
          type: Array,
          observer: '_selectedItemsChanged'
        }
      },

      _selectedItemsChanged: function() {
        console.log(this.selectedItems);
      },

      handleResponse: function(e, request) {
        this.files = request.response
      },

      onUploadFile: function() {
        this.$.dialog.open();
      },

      uploadFile: function() {
        if (!this.uploadFileList || 0 >= this.uploadFileList.length) {
          return;
        }

        var formData = new FormData();

        // Add the display name
        formData.append('displayName', 'My display name');

        // Add files to the form data
        for (var i = 0; i < this.uploadFileList.length; i++) {
          formData.append('datafile-' + i, this.uploadFileList[i]);
        }

        // Create the request
        var request = new XMLHttpRequest();
        request.open('POST', '/file');
        request.send(formData);
  
        var self = this;
        setTimeout(function() {
          self.$.files_request.generateRequest();
        }, 250);
      },

      onDeleteFile: function(e) {
        var request = new XMLHttpRequest();
        request.open('DELETE', '/file/' + e.model.item.id);
        request.send();
  
        var self = this;
        setTimeout(function() {
          self.$.files_request.generateRequest();
        }, 250);
      }
    });

  }(Polymer));
</script>